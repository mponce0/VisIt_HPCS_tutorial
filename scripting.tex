\begin{comment}
http://www.visitusers.org/index.php?title=VisIt-tutorial-Python-scripting
http://www.visitusers.org/index.php?title=VisIt-tutorial-Advanced-scripting
http://www.visitusers.org/index.php?title=Exporting_databases
abc Tips for searching for help
http://www.visitusers.org/index.php?title=VisIt-tutorial-Python-scripting#Learning_the_CLI
\end{comment}

\defverbatim[colored]\guiless{
  \begin{lstlisting}[language=bash,basicstyle=\ttfamily,keywordstyle=\color{red}]
    $ /path/to/VisIt -nowin -cli -s script.py
  \end{lstlisting}
}

\begin{frame}{Python scripting in VisIt}{}
  \footnotesize{
    \begin{itemize}\setlength{\itemsep}{1mm}
    \item[\ding{80}] You can run VisIt Python scripts without the GUI from the command line (analogue of
      ParaView's 'pvbatch')\guiless\vspace{-3mm}
      \begin{itemize}\setlength{\itemsep}{0mm}
      \item very useful for running a batch rendering job on a supercomputer
      \end{itemize}
    \item[\ding{80}] VisIt has a built-in Python 2.7 shell through Controls \ra Launch CLI. It'll start
      VisIt's Python interpreter in a terminal and attach it to the running VisIt session on a specific
      port on your laptop with a one-time security key
    \item[\ding{80}] Alternatively, Controls \ra Command provides a text editor with Python syntax
      highlighting and an Execute button that tells VisIt to execute the script; lets us save up to eight
      snippets of Python code
    \item {\color{red}Controls \ra Command window lets you record your GUI actions into Python code that
      you can use in your scripts (similar to ParaView's Trace Tool)}
    \item {\color{blue}In addition, can use Python in Controls \ra Expressions \ra Python Expression
      Editor (similar to the Programmable filter in ParaView)}
    \item {\color{blue}In addition, can use Python in Controls \ra Query \ra Python Query Editor}
    \end{itemize}}
\end{frame}

\defverbatim[colored]\drawPseudoColor{
  \begin{lstlisting}[language=python,basicstyle=\footnotesize,keywordstyle=\color{red}]
dir = "/Users/razoumov/Documents/teaching/visitWorkshop/"
OpenDatabase(dir+"sineEnvelope.nc")  
AddPlot("Pseudocolor", "density")
DrawPlots()
  \end{lstlisting}
}

\begin{frame}{Adding plots (typing in interactive shell)}
  Starting from scratch, start Python shell Controls \ra Launch CLI, and
  type in the following commands {\color{magenta}(adjust the file path!)}:\drawPseudoColor
  \pause
  \begin{itemize}\setlength{\itemsep}{3mm}
  \item Each plot in VisIt has a number of attributes that control the appearance of the plot
  \item To access them, first create a \emph{plot attributes object} by calling a function
    {\color{magenta}PlotName}Attributes(), e.g., PseudocolorAttributes(), or VolumeAttributes()
  \item If changing attributes, pass the object to the SetPlotOptions()
  \item If setting new defaults, pass the object to SetDefaultPlotOptions()
  \end{itemize}
\end{frame}

\defverbatim[colored]\setMinMax{
  \begin{lstlisting}[language=python,basicstyle=\footnotesize,keywordstyle=\color{red}]
p = PseudocolorAttributes()
p   # will print out all attributes
p.min, p.max = 1, 1.1   # colour map range
p.minFlag, p.maxFlag = 1, 1   # turn it on
SetPlotOptions(p) # set active plot attributes
help(SetPlotOptions)
  \end{lstlisting}
}

\defverbatim[colored]\cancelMinMax{
  \begin{lstlisting}[language=python,basicstyle=\footnotesize,keywordstyle=\color{red}]
p.minFlag, p.maxFlag = 0,0   # turn it off
SetPlotOptions(p)
  \end{lstlisting}
}

\defverbatim[colored]\greens{
  \begin{lstlisting}[language=python,basicstyle=\footnotesize,keywordstyle=\color{red}]
p.colorTableName = "Greens" # new colour map
SetPlotOptions(p)
  \end{lstlisting}
}

\begin{frame}{Probing and setting plot attributes (interactive shell)}
  Add the following commands:
  \setMinMax
  \pause
  Revert to the original colour map range:
  \cancelMinMax
  \pause
  Pick a different colour map:
  \greens
\end{frame}

\defverbatim[colored]\runScript{
  \begin{lstlisting}[language=python,basicstyle=\scriptsize,keywordstyle=\color{red}]
os.chdir('/Users/razoumov/Documents/teaching/visitWorkshop/scripts')
# os.chdir('C:\Users\Josh\Desktop\20130216')   # Windows example
# os.getcwd()   # to check current directory
Source('scriptName.py')
  \end{lstlisting}
}

\begin{frame}{Running scriptName.py from inside GUI}
  \begin{itemize}\setlength{\itemsep}{3mm}
  \item Option 1: paste the code into Controls \ra Command window and click Execute
  \item Option 2: inside the Python shell change to the directory containing scripts (can use relative or
    absolute paths) and run your script
    \runScript
  \end{itemize}
\end{frame}

\begin{frame}{Setting attributes before drawing}
  Now let's start from scratch (\texttt{sineEnvelope.nc} loaded), set an attribute, and draw a plot:
  \lstinputlisting[language=python,showstringspaces=false,
    basicstyle=\scriptsize,keywordstyle=\color{red}]{scripts/scratch.py}
\end{frame}

\begin{frame}{Scripting an operator}
  With \texttt{sineEnvelope.nc} loaded, run the following:
  \lstinputlisting[language=python,showstringspaces=false,
    basicstyle=\scriptsize,keywordstyle=\color{red}]{scripts/addOperator.py}
  \pause\bigskip
  {\small Now let's produce 3 single-isosurface plots at density = 0.6, 1.0, 1.4, respectively:}
  \lstinputlisting[language=python,showstringspaces=false,
    basicstyle=\scriptsize,keywordstyle=\color{red}]{scripts/threeSurfaces.py}
\end{frame}

\defverbatim[colored]\writeToDisk{
  \begin{lstlisting}[language=python,basicstyle=\scriptsize,keywordstyle=\color{red}]
s = SaveWindowAttributes()
s.format = s.PNG
s.fileName = 'someName'
s.outputToCurrentDirectory = 0   # for some reason this is 'yes'
s.outputDirectory = "/path/to/directory"
SetSaveWindowAttributes(s)
...
build and display a plot
...
name = SaveWindow()   # returns the name of the file it wrote
  \end{lstlisting}
}

\begin{frame}{Saving images to disk}
  \writeToDisk\pause
  Now let's save the three surfaces to disk:
  \lstinputlisting[language=python,showstringspaces=false,
    basicstyle=\scriptsize,keywordstyle=\color{red}]{scripts/saveSurfaces.py}
\end{frame}

\begin{frame}{Animating camera position: create a plot}
  With \texttt{sineEnvelope.nc} loaded, draw a single isosurface at density=0.3 in green:
  \lstinputlisting[language=python,showstringspaces=false,
    basicstyle=\footnotesize,keywordstyle=\color{red}]{scripts/oneSurface.py}
    \pause
  \lstinputlisting[language=python,showstringspaces=false,
    basicstyle=\scriptsize,keywordstyle=\color{red}]{scripts/printView.py}
\end{frame}

\begin{frame}{Animating camera position: set a view by hand}
  Create a view by hand by explicitly setting the important attributes:
  \lstinputlisting[language=python,showstringspaces=false,
    basicstyle=\scriptsize,keywordstyle=\color{red}]{scripts/setControlPoint.py}
\end{frame}

\begin{frame}{Animating camera position: rotate around the vertical axis}
  \lstinputlisting[language=python,showstringspaces=false,
    basicstyle=\footnotesize,keywordstyle=\color{red}]{scripts/rotateAroundVertical.py}
\end{frame}

\begin{frame}{Animating camera position: fly into the volume and out}
  \lstinputlisting[language=python,showstringspaces=false,
    basicstyle=\footnotesize,keywordstyle=\color{red}]{scripts/flyInOut.py}
\end{frame}

\begin{frame}{Animating camera position: animate the perspective angle}
  \lstinputlisting[language=python,showstringspaces=false,
    basicstyle=\footnotesize,keywordstyle=\color{red}]{scripts/perspective.py}
\end{frame}

\begin{frame}{Camera animation: interpolating between control points}
  First, define a function to copy all attributes from one control point to another
  \lstinputlisting[language=python,showstringspaces=false,
    basicstyle=\footnotesize,keywordstyle=\color{red}]{scripts/copyView.py}
\end{frame}

\begin{frame}{Camera animation: interpolating between control points}
  Next, set three new control points, based on c0
  \lstinputlisting[language=python,showstringspaces=false,
    basicstyle=\footnotesize,keywordstyle=\color{red}]{scripts/threeControlPoints.py}
\end{frame}

\begin{frame}{Camera animation: interpolating between control points}
  Finally, interpolate between the control points with a small step
  \lstinputlisting[language=python,showstringspaces=false,
    basicstyle=\footnotesize,keywordstyle=\color{red}]{scripts/interpolate.py}
\end{frame}

\begin{frame}{Animating an operator: no animation yet}
  \lstinputlisting[language=python,showstringspaces=false,
    basicstyle=\scriptsize,keywordstyle=\color{red}]{scripts/clipStatic.py}
\end{frame}

\defverbatim[colored]\ffmpeg{
  \begin{lstlisting}[language=bash,basicstyle=\scriptsize,keywordstyle=\color{red}]
    ffmpeg -r 10 -i image%02d.png -c:v libx264 -pix_fmt yuv420p \
       -vf "scale=trunc(iw/2)*2:trunc(ih/2)*2" movie.mp4
  \end{lstlisting}
}

\begin{frame}{Animating an operator: exercise}
  \qquad Try to do the following:\bigskip
  \begin{enumerate}\setlength{\itemsep}{3mm}
  \item Modify the previous slide's script to animate the clip plane through the volume from z=0 to z=1
  \item Write each image to disk as PNG
  \item Use a third-party tool to merge these into a movie;
    e.g., in Linux/MacOSX can use ffmpeg to merge frames into an efficiently compressed
    Quicktime-compatible MP4\ffmpeg
  \end{enumerate}
\end{frame}

\defverbatim[colored]\outIdentical{
  \begin{lstlisting}[language=python,basicstyle=\scriptsize,keywordstyle=\color{red}]
    density -- Min = 0.0194448 (node 323832 at coord <32, 38, 32>)
    density -- Max = 1.99497 (node 394939 at coord <39, 49, 39>)
    (0.019444825127720833, 1.9949746131896973)
  \end{lstlisting}
}

\begin{frame}{Scripting queries: minMax of Pseudocolor}
  \lstinputlisting[language=python,showstringspaces=false,
    basicstyle=\scriptsize,keywordstyle=\color{red}]{scripts/queryPseudocolor.py}
  \begin{block}{}{}\vspace{-3mm}\outIdentical\vspace{-3mm}\end{block}
  \bigskip
  Most queries require an active non-hidden plot\\ ... so, do they query the original data or the plot?
\end{frame}

\begin{frame}{Scripting queries: minMax of Contour}
  \lstinputlisting[language=python,showstringspaces=false,
    basicstyle=\scriptsize,keywordstyle=\color{red}]{scripts/queryContour.py}
  \pause
  Produces exactly the same query output!\\
  Seems like we query the original 3D data, not the plot.\\
  $\Rightarrow$ Why require a plot when we run a query not on the plot but on the original data?...
\end{frame}

\begin{frame}{Scripting queries: weighted variable sum of Slice}
  Answer: query script authors can make it operate on \emph{anything in the pipeline},
  so best to check documentation and/or test your script
  \bigskip
  \lstinputlisting[language=python,showstringspaces=false,
    basicstyle=\scriptsize,keywordstyle=\color{red}]{scripts/querySlice.py}
\end{frame}

\begin{frame}{Recording GUI actions to Python scripts}
  \begin{itemize}\setlength{\itemsep}{3mm}
  \item Controls \ra Command window lets you convert your GUI workflow into a Python code (similar to
    ParaView's Trace Tool)
    \begin{enumerate}\setlength{\itemsep}{1mm}
    \item delete all plots and databases
    \item select Controls \ra Command window to open the Commands window
    \item press Record
    \item load the file \texttt{sineEnvelope.nc}, add a plot, draw it
    \item press Stop
    \item you'll see an automatically generated script in the Commands window
    \end{enumerate}
  \item Often the output will be very verbose and contain many unnecessary commands, which can be edited out
    \begin{itemize}\setlength{\itemsep}{1mm}
    \item try translating object rotation into Python
    \end{itemize}
  \end{itemize}
\end{frame}

\begin{frame}{Advanced topics in scripting}
  \begin{itemize}\setlength{\itemsep}{3mm}
  \item Exporting databases
  \item Automating data analysis
  \item Python Expression Editor
  \item Python Query Editor
  \item Setting up your own buttons in the VisIt GUI
%        \url{http://www.visitusers.org/index.php?title=Visitrc_file}
  \item Setting up callbacks that get called whenever events happen in VisIt
%        \url{http://www.visitusers.org/index.php?title=Python_callbacks}
  \item Creating custom Qt GUIs based on VisIt
%        \url{http://www.visitusers.org/index.php?title=PySide_Recipes}
  \end{itemize}
\end{frame}
